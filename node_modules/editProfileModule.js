/*
 * Module for editing a user profile
 *
 * Created By: Jonathan Moore, Corliss Fung
 */ 

var dbAccess = require('dbAccess');
var qs = require('querystring');
var crypto = require('crypto');
var url = require('url');


var EditProfileModule = exports.EditProfileModule = function() { 
};


/*
 * Save updated user profile to the database
 */
EditProfileModule.buildEditProfilePage = function(request, response) 
{
	console.log("Edit user profile page requested.");

	var urlInfo = url.parse(request.url, true);
	var userid = urlInfo.query['id'];

	// find which user is logged in and get existing profile
	//dbAccess.find('users', { conditions:['id="' + userid + '"'] }, function(error, results){
	request.getUser(function(error, user){	
		if (error){
			// If a database error is generated, just spit out failure message
			console.log('Error occured reading user profile from DataBase:' + error.toString());
			console.log(sqlUpdateUserProfile);
			response.writeHead(500, { 'Content-Type' : 'text/html' }); 
			response.end('<html><body><h1>Server Error!  Please bear with us as we resolve our issues.</h1></body></html>');
		}

		else if (user){
			
			dbAccess.find('interests', {conditions:['user_id="'+userid+'"']}, function(error, interests){
			
			
			
				values = {};
				values.username = user.name;
				values.email = user.email;
				values.neighborhood = user.neighborhood || '';
				values.postal_code = user.postal_code || '';
				values.userid = user.id;
				values.facebook_account = user.facebook_account || '';
				values.twitter_account = user.twitter_account || '';
				values.website = user.website || '';
			
				if(interests.length > 0)
				{
					interest = interests[0];
					
					if(interest.interest_topic == 'undefined'){
						values.interest_topic = '';
					}else{
						values.interest_topic = interest.interest_topic;
					}
					if(interest.interest_location == 'undefined'){
						values.interest_location = '';
					}else{
						values.interest_location = interest.interest_location;
					}
				}else{
					values.interest_topic = '';
					values.interest_location = '';
				}
				
				response.render('views/editProfile.html', values);
			});
		}
		else
		{
			response.flash.addError('You must be logged in to edit your profile.');
			response.redirectTo('/signin');
		}
	});
}

/*
 * Save updated user profile to the database
 */
EditProfileModule.handleEditProfile = function(request, res) 
{
	console.log("Update user profile initiated.");

/*	//Get User ID from login
	request.getUser(function(error, user){
		if(error){
			res.writeHead(500, { 'Content-Type' : 'text/html' });
			res.end('<html><body><h1>Edit Profile Failed</h1></body></html>');
		}
		else if(user){
			//console.log(user);
			var userid = user['id'];
		}
		else{
			res.writeHead(302, { 'Location' : '/login' });
			res.end();
		}
	});
*/
	
	// The form data from the request is first read into editProfileBody
	var editProfileBody = '';	
	request.on('data', function(chunk){
		editProfileBody += chunk.toString();
	});
	
	
	// When all data is received, the data is parsed and inserted into database
	request.on('end', function(){
		// parse the update profile information
		var updateInfo = qs.parse(editProfileBody);
//		var oldusername = updateInfo['oldusername'];
		var userid = updateInfo['userid'];
		var username = updateInfo['username'];
		var email = updateInfo['email'];
		var neighborhood = updateInfo['neighborhood'];
		var postalcode = updateInfo['postal_code'];
		var oldpassword = updateInfo['password'];
		var newpassword = updateInfo['new_password'];
		var confirmpassword = updateInfo['confirm_password'];
		var facebookaccount = updateInfo['facebook'];
		var twitteraccount = updateInfo['twitter'];
		var website = updateInfo['website'];

		// Encrypt passwords
		if (!newpassword){
			newpassword = oldpassword;
		}
		var newCryptoPassword = crypto.createHash('md5').update(newpassword).digest("hex");
		var oldCryptoPassword = crypto.createHash('md5').update(oldpassword).digest("hex");

		// Verify old password
		var sqlUpdateUserProfile = "SELECT * FROM users WHERE id='" + userid +"';";
		dbAccess.runQuery(sqlUpdateUserProfile, function(error, rows){
			if(error) {
				// If a database error is generated, just spit out failure message
				console.log('Error occured saving to DataBase during profile update:' + error.toString());
				console.log(sqlUpdateUserProfile);
				res.writeHead(500, { 'Content-Type' : 'text/html' }); 
				res.end('<html><body><h1>Edit Profile Failed</h1></body></html>');
				return;
			}
			else {
				// check that passwords are a match
				var dbpassword = rows[0]['password'];
				if (oldCryptoPassword != dbpassword){
					res.flash.addError('Incorrect Password');
					res.redirectTo('/editProfile');
				}
				else {
					//updateUserProfile();
					// Build SLQ and insert the new user into the database
					console.log("updateUserProfile");
					var sqlUpdateUserProfile = "UPDATE users SET "
							+ "name='" + username
							+ "', email='" + email
							+ "', neighborhood='" + neighborhood
							+ "', postal_code='" + postalcode
							+ "', facebook_account='" + facebookaccount
							+ "', twitter_account='" + twitteraccount
							+ "', website='" + website
							+ "', password='" + newCryptoPassword
							+ "' "
							+ "WHERE id='" + userid
							+ "' AND password='" + oldCryptoPassword
							+ "';"; 
					dbAccess.runQuery(sqlUpdateUserProfile, function(error, rows){
						if(error) {
							// If a database error is generated, just spit out failure message
							console.log('Error occured saving to DataBase during profile update:' + error.toString());
							console.log(sqlUpdateUserProfile);
							res.writeHead(500, { 'Content-Type' : 'text/html' });
							res.end('<html><body><h1>Edit Profile Failed</h1><a href="/index.html">Home</a></body></html>');
						}
						else {
							console.log('database save successful!');
							// On success, redirect user to editProfile page.
							res.flash.addSuccess('Profile updated successfully');
							res.redirectTo('/editProfile');
						}
					});
				}
			}
		});
	});
}

