var user = require('user'),
dbAccess = require('./dbAccess'),
queryString = require('querystring');

var view = 'views/signIn.html';

exports.signin = function(req, res) {
	if(req.method != 'POST'){
		res.render(view);
		return;
	}
		
	req.content = '';
	
	req.on('data', function(chunk) {
		req.content += chunk;
	})
	
	req.on('end', function(){
		req.params = queryString.parse(req.content);
		
		var params = req.params; 
		//This is the cookie session expiration date
		var date = new Date();
		date.setDate(date.getDate() + 7);
		
		user.authenticate(params.username, params.password, function (error, user) {
			
			if (error)
				throw error;
			
			if (user) {
				// This generates a unique session and then assigns it to 
				// the user cookie and inserts it in the sessions table.
				var sessionString = generateHash(user.id);
				var query = "INSERT INTO sessions (user_id, session_hash) VALUES ('" + user.id + "','" + sessionString + "');";
	
				dbAccess.runQuery(query, function(error){
					res.setHeader('Set-Cookie', 'session=' + sessionString + '; Expires=' + date);
					res.flash.addSuccess('Logged in as ' + user.name)
					res.redirectTo('/'); // redirect to index.
				});
			}else{
				res.flash.addError('Sign In Failed. Please try again.');
				res.render(view);
			}
		}); 
	})
}

function generateHash(id) {
	var timestamp = new Date().getTime();
	var toHash = (timestamp+id).toString();
	return user.md5hash(toHash);
}

exports.signout = function(req, res){
	res.setHeader('Set-Cookie', 'session=0; Expires=Thu, 01-Jan-1970 00:00:01 GMT');
	res.flash.addSuccess('Successfully logged out.')
	res.redirectTo('/');
}
